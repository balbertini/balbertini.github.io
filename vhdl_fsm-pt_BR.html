
<!DOCTYPE html>
<html lang="pt_br">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="robots" content="index, follow" />

  <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro|Source+Sans+Pro:300,400,400i,700" rel="stylesheet">

    <link rel="stylesheet" type="text/css" href="https://balbertini.github.io/theme/stylesheet/style.min.css">


    <link id="pygments-light-theme" rel="stylesheet" type="text/css"
          href="https://balbertini.github.io/theme/pygments/github.min.css">


  <link rel="stylesheet" type="text/css" href="https://balbertini.github.io/theme/font-awesome/css/fontawesome.css">
  <link rel="stylesheet" type="text/css" href="https://balbertini.github.io/theme/font-awesome/css/brands.css">
  <link rel="stylesheet" type="text/css" href="https://balbertini.github.io/theme/font-awesome/css/solid.css">


    <link href="https://balbertini.github.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="B.Albertini's site Atom">


    <link rel="shortcut icon" href="/images/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/images/favicon.ico" type="image/x-icon">

<!-- Google Analytics -->
<script type="text/javascript">
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-125173293-1', 'auto');
  ga('send', 'pageview');
</script>
<!-- End Google Analytics -->
    <!-- Chrome, Firefox OS and Opera -->
    <meta name="theme-color" content="#333">
    <!-- Windows Phone -->
    <meta name="msapplication-navbutton-color" content="#333">
    <!-- iOS Safari -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- Microsoft EDGE -->
    <meta name="msapplication-TileColor" content="#333">

<meta name="author" content="Bruno Albertini" />
<meta name="description" content="Máquinas de estado em VHDL." />
<meta name="keywords" content="vhdl, state machine">


<meta property="og:site_name" content="B.Albertini's site"/>
<meta property="og:title" content="Máquinas de estado em VHDL"/>
<meta property="og:description" content="Máquinas de estado em VHDL."/>
<meta property="og:locale" content="pt_BR"/>
<meta property="og:url" content="https://balbertini.github.io/vhdl_fsm-pt_BR.html"/>
<meta property="og:type" content="article"/>
<meta property="article:published_time" content="2019-03-18 11:06:00-03:00"/>
<meta property="article:modified_time" content="2019-03-19 10:58:00-03:00"/>
<meta property="article:author" content="https://balbertini.github.io/author/bruno-albertini.html">
<meta property="article:section" content="vhdl"/>
<meta property="article:tag" content="vhdl"/>
<meta property="article:tag" content="state machine"/>
<meta property="og:image" content="/images/profile.png">

  <title>B.Albertini's site &ndash; Máquinas de estado em VHDL</title>

</head>
<body class="light-theme">
  <aside>
    <div>
      <a href="https://balbertini.github.io">
        <img src="/images/profile.png" alt="B.Albertini" title="B.Albertini">
      </a>

      <h1>
        <a href="https://balbertini.github.io">B.Albertini</a>
      </h1>

<p>Professor</p>

      <nav>
        <ul class="list">


              <li>
                <a target="_self"
                   href="https://balbertini.github.io/pages/sd-pt_BR.html#sd">
                  Sistemas Digitais
                </a>
              </li>
              <li>
                <a target="_self"
                   href="https://balbertini.github.io/pages/disciplinas-pt_BR.html#disciplinas">
                  Disciplinas
                </a>
              </li>
              <li>
                <a target="_self"
                   href="https://balbertini.github.io/pages/research-pt_BR.html#research">
                  Pesquisa
                </a>
              </li>
              <li>
                <a target="_self"
                   href="https://balbertini.github.io/pages/sobre-pt_BR.html#sobre">
                  Sobre
                </a>
              </li>
              <li>
                <a target="_self"
                   href="https://balbertini.github.io/pages/vhdl-pt_BR.html#vhdl">
                  VHDL
                </a>
              </li>

        </ul>
      </nav>

      <ul class="social">
          <li>
            <a  class="sc-github" href="https://github.com/balbertini" target="_blank">
              <i class="fab fa-github"></i>
            </a>
          </li>
          <li>
            <a  class="sc-rss" href="//balbertini.github.io/feeds/all.atom.xml" target="_blank">
              <i class="fas fa-rss"></i>
            </a>
          </li>
      </ul>
    </div>

  </aside>
  <main>


<article class="single">
  <header>
      
    <h1 id="vhdl_fsm">Máquinas de estado em VHDL</h1>
    <p>
      Publicado em 18/03/2019 (Seg) na categoria <a href="https://balbertini.github.io/category/vhdl.html">vhdl</a>

        &#8226; 9 min de leitura 
    </p>
  </header>


  <div>
    <p>Máquinas de estado são muito comuns pois, em sistemas digitais, todos os circuitos sequenciais podem ser vistos como uma máquina de estados finita. No entanto, especificá-las em VHDL é um desafio para os projetistas novatos devido aos problemas que surgem quando o tempo está envolvido. Circuitos combinatórios não dependem de tempo e não possuem memória, porém máquinas de estado possuem e precisam ser projetadas com o devido cuidado. Neste artigo mostrarei algumas formas seguras de especificar corretamente máquinas de estado finitas síncronas e determinísticas em VHDL.</p>
<h3>Revisitando o conceito de máquinas de estado</h3>
<p><img alt="Modelo de FSM" src="https://balbertini.github.io/images/sd/fsmmodel.png"></p>
<p>O modelo base de qualquer máquina de estados em sistemas digitais pode ser visto na figura. É composto por um elemento de memória (S) e duas funções combinatórias, uma de transição de estados (T) e outra de saída (G). Quando a função de saída depende somente do estado (ausência da seta tracejada na figura), dizemos que a máquina segue o modelo de Moore. Ao contrário, quando a saída da máquina depende do estado e da entrada (presença da seta tracejada na figura), dizemos que a máquina segue o modelo de Mealy. Em ambos os casos, somente o elemento de memória é sequencial. As funções são puramente combinatórias e dependem somente da entrada (da função) para produzir a saída. Note que, apesar de dependerem apenas na sua entrada, ambas as funções recebem a saída do elemento combinatório como entrada.</p>
<p>Resumindo:</p>
<ul>
<li>T é combinatória, recebe o estado e a entrada e produz o próximo estado;</li>
<li>G é combinatória, recebe o estado (Moore) ou o estado e a entrada (Mealy), e produz a saída;</li>
<li>S é um elemento de memória que armazena o estado atual.</li>
</ul>
<h2>Descrevendo a FSM em VHDL usando Moore ou Mealy</h2>
<p>Aqui parte-se do pressuposto que você desenhou o diagrama de transição de estados da sua máquina de estados, ela é finita e determinística. De fato, a grande maioria dos problemas sequenciais em sistemas digitais possuem a sua dificuldade no desenho do diagrama de transição e não na implementação. Em outras palavras, implementar uma máquina de estados em VHDL é relativamente simples, pois a parte difícil da solução do problema está imbuída no diagrama de transição.</p>
<p>Comece sua máquina de estados declarando a entidade e, consequentemente, a interface de entrada e saída da sua máquina de estados.</p>
<p>Na arquitetura, sempre teremos duas partes: a parte sequencial e a parte combinatória. O elemento de memória representa a parte sequencial da máquina de estado e portanto é sensível ao <em>clock</em>. Para implementá-lo dessa maneira, utiliza-se o <code>process</code>. Para detalhes sobre o uso correto do <code>process</code>, veja <a href="https://balbertini.github.io/vhdl_sequential-pt_BR.html">o artigo sobre circuitos síncronos</a>. De fato, você não precisa usar <code>process</code> para mais nada em VHDL, exceto para a parte sequencial das máquinas de estado finitas. A parte combinatória é o que diferencia os estilos de codificação em VHDL, e neste artigo veremos duas formas, através de exemplos, portanto não deixe de lê-los e entendê-los.</p>
<h3>Exemplo 1 (Moore)</h3>
<p><img src='https://balbertini.github.io/images/sd/fsmexemplo1.png' width="15%" align="right" style="padding-left:5%" />
A máquina que iremos implementar como exemplo é a máquina de Moore da figura ao lado. Contém apenas dois estados e todas as quatro transições possíveis totalmente especificadas. Comecemos pela declaração de uso das bibliotecas e pela entidade:</p>
<div class="highlight"><pre><span></span><span class="k">library</span> <span class="nn">ieee</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">ieee.numeric_bit.rising_edge</span><span class="p">;</span>

<span class="k">entity</span> <span class="nc">fsm</span> <span class="k">is</span>
  <span class="k">port</span><span class="p">(</span>
    <span class="n">entrada</span><span class="o">:</span> <span class="k">in</span> <span class="kt">bit</span><span class="p">;</span>
    <span class="n">saida</span><span class="o">:</span> <span class="k">out</span> <span class="kt">bit</span><span class="p">;</span>
    <span class="n">clock</span><span class="p">,</span> <span class="n">reset_n</span><span class="o">:</span> <span class="k">in</span> <span class="kt">bit</span>
  <span class="p">);</span>
<span class="k">end</span> <span class="nc">fsm</span><span class="p">;</span>
</pre></div>


<div style="border: 0px; overflow: auto;width: 100%;"></div>

<p>Na descrição da arquitetura, o que teremos de novidade é a utilização de um tipo composto definido pelo usuário. O tipo composto é uma enumeração e representa o conjunto S (todos os estados possíveis). Após declarado o tipo composto, é possível declarar sinais e variáveis deste tipo, então usaremos o tipo declarado para declarar a variável de estado, ou seja, o elemento de memória que armazenará o estado.</p>
<h4>Exemplo 1 (Moore) - Estilo tradicional</h4>
<p>Neste primeiro estilo de descrição, a arquitetura é descrita usando exatamente o modelo tradicional de máquina de estados, ou seja, o elemento de memória é sequencial (dentro do <code>process</code>) e as funções combinatórias (fora do <code>process</code>).</p>
<p><img src='https://balbertini.github.io/images/sd/fsmvhdl01.png' width="50%" align="right" style="padding-left:0%" /></p>
<div class="highlight"><pre><span></span><span class="k">architecture</span> <span class="nc">proccomb</span> <span class="k">of</span> <span class="nc">fsm</span> <span class="k">is</span>
  <span class="k">type</span> <span class="n">estado_t</span> <span class="k">is</span> <span class="p">(</span><span class="n">A</span><span class="p">,</span><span class="n">B</span><span class="p">);</span>
  <span class="k">signal</span> <span class="n">PE</span><span class="p">,</span><span class="n">EA</span> <span class="o">:</span> <span class="n">estado_t</span><span class="p">;</span>
<span class="k">begin</span>
  <span class="nc">sincrono</span><span class="o">:</span> <span class="k">process</span><span class="p">(</span><span class="n">clock</span><span class="p">,</span> <span class="n">reset_n</span><span class="p">)</span>
  <span class="k">begin</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">reset_n</span><span class="o">=</span><span class="sc">&#39;0&#39;</span><span class="p">)</span> <span class="k">then</span>
      <span class="n">EA</span> <span class="o">&lt;=</span> <span class="n">A</span><span class="p">;</span>
    <span class="k">elsif</span> <span class="p">(</span><span class="n">rising_edge</span><span class="p">(</span><span class="n">clock</span><span class="p">))</span> <span class="k">then</span>
      <span class="n">EA</span> <span class="o">&lt;=</span> <span class="n">PE</span><span class="p">;</span>
    <span class="k">end</span> <span class="k">if</span><span class="p">;</span>
  <span class="k">end</span> <span class="k">process</span> <span class="nc">sincrono</span><span class="p">;</span>
  <span class="n">PE</span> <span class="o">&lt;=</span>
    <span class="n">A</span> <span class="k">when</span> <span class="n">entrada</span><span class="o">=</span><span class="sc">&#39;0&#39;</span> <span class="k">and</span> <span class="n">EA</span><span class="o">=</span><span class="n">A</span> <span class="k">else</span>
    <span class="n">B</span> <span class="k">when</span> <span class="n">entrada</span><span class="o">=</span><span class="sc">&#39;1&#39;</span> <span class="k">and</span> <span class="n">EA</span><span class="o">=</span><span class="n">A</span> <span class="k">else</span>
    <span class="n">B</span> <span class="k">when</span> <span class="n">entrada</span><span class="o">=</span><span class="sc">&#39;0&#39;</span> <span class="k">and</span> <span class="n">EA</span><span class="o">=</span><span class="n">B</span> <span class="k">else</span>
    <span class="n">A</span> <span class="k">when</span> <span class="n">entrada</span><span class="o">=</span><span class="sc">&#39;1&#39;</span> <span class="k">and</span> <span class="n">EA</span><span class="o">=</span><span class="n">B</span> <span class="k">else</span>
    <span class="n">A</span><span class="p">;</span>
  <span class="n">saida</span> <span class="o">&lt;=</span>
    <span class="sc">&#39;0&#39;</span> <span class="k">when</span> <span class="n">EA</span><span class="o">=</span><span class="n">A</span> <span class="k">else</span>
    <span class="sc">&#39;1&#39;</span> <span class="k">when</span> <span class="n">EA</span><span class="o">=</span><span class="n">B</span> <span class="k">else</span>
    <span class="sc">&#39;0&#39;</span><span class="p">;</span>
<span class="k">end</span> <span class="k">architecture</span> <span class="nc">proccomb</span><span class="p">;</span>
</pre></div>


<p>Note que há somente um processo. O processo faz o <em>reset</em> assíncrono da máquina de estados, colocando-a no estado A (veja a seta de início chegando no estado A do diagrama de transição de estados). Caso o <em>reset</em> não esteja ativo, o processo faz uma única tarefa que é copiar o sinal PE (de Próximo Estado) para o sinal EA (de Estado Atual) na borda de subida do <em>clock</em>. Neste contexto, apenas o sinal EA representa um elemento combinatório pois fora destas duas condições, o sinal EA é mantido inalterado. O comportamento é exatamente o de um <em>flip-flop</em> tipo D e, de fato, podemos ver que o circuito gerado contém exatamente um <em>flip-flop</em>, pois temos somente dois estados possíveis. Caso o tipo composto <code>estado_t</code> possuísse mais de dois estados, o número de <em>flip-flops</em> seria maior para acomodar o maior número de estados.</p>
<p>Fora do processo, temos duas declarações concorrentes ao <code>process</code>, que representam as duas funções combinatórias. A primeira calcula o próximo estado (<code>PE&lt;=...</code>) e a segunda calcula a saída (<code>saida&lt;=...</code>).</p>
<p>Este estilo tem a vantagem de ser muito próximo do modelo tradicional de máquinas de estado. O processo síncrono é muito simples (será similar independentemente da máquina) e com pouco espaço para erros. A desvantagem é que este estilo se torna críptico rapidamente, pois a descrição combinatória das funções de transição e de próximo estado crescerão exponencialmente em complexidade e tamanho junto com a complexidade da máquina, tornando-se ilegíveis rapidamente.</p>
<p>Use esse estilo nas suas primeiras máquinas de estado, para garantir que você não terá problemas de sincronismo, ou se a máquina for muito simples ou com poucos estados.</p>
<h4>Exemplo 1 (Moore) - Estilo com dois <code>process</code></h4>
<p>No segundo estilo, levamos a descrição combinatória para dentro de um <code>process</code> novo, mantendo o <code>process</code> sequencial que faz o papel de elemento de memória inalterado. Este estilo exige um cuidado muito grande pois estamos descrevendo um elemento combinatório dentro de uma primitiva de VHDL que indica para o sintetizador que estamos descrevendo algo sequencial. Temos que ser claros com a descrição para que o sintetizador entenda que a variável de estados é o sinal EA somente, e os outros sinais (neste caso o PE e a <code>saida</code>), são combinatórios.</p>
<p><img src='https://balbertini.github.io/images/sd/fsmvhdl02.png' width="50%" align="right" style="padding-left:0%" /></p>
<div class="highlight"><pre><span></span><span class="k">architecture</span> <span class="nc">doisproc</span> <span class="k">of</span> <span class="nc">fsm</span> <span class="k">is</span>
  <span class="k">type</span> <span class="n">estado_t</span> <span class="k">is</span> <span class="p">(</span><span class="n">A</span><span class="p">,</span><span class="n">B</span><span class="p">);</span>
  <span class="k">signal</span> <span class="n">PE</span><span class="p">,</span><span class="n">EA</span> <span class="o">:</span> <span class="n">estado_t</span><span class="p">;</span>
<span class="k">begin</span>

  <span class="nc">sincrono</span><span class="o">:</span> <span class="k">process</span><span class="p">(</span><span class="n">clock</span><span class="p">,</span> <span class="n">reset_n</span><span class="p">,</span> <span class="n">PE</span><span class="p">)</span>
  <span class="k">begin</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">reset_n</span><span class="o">=</span><span class="sc">&#39;0&#39;</span><span class="p">)</span> <span class="k">then</span>
      <span class="n">EA</span> <span class="o">&lt;=</span> <span class="n">A</span><span class="p">;</span>
    <span class="k">elsif</span> <span class="p">(</span><span class="n">rising_edge</span><span class="p">(</span><span class="n">clock</span><span class="p">))</span> <span class="k">then</span>
      <span class="n">EA</span> <span class="o">&lt;=</span> <span class="n">PE</span><span class="p">;</span>
    <span class="k">end</span> <span class="k">if</span><span class="p">;</span>
  <span class="k">end</span> <span class="k">process</span> <span class="nc">sincrono</span><span class="p">;</span>

  <span class="nc">combinatorio</span><span class="o">:</span> <span class="k">process</span><span class="p">(</span><span class="n">EA</span><span class="p">,</span> <span class="n">entrada</span><span class="p">)</span>
  <span class="k">begin</span>
    <span class="n">saida</span> <span class="o">&lt;=</span> <span class="sc">&#39;0&#39;</span><span class="p">;</span>
    <span class="k">case</span><span class="p">(</span><span class="n">EA</span><span class="p">)</span> <span class="k">is</span>
      <span class="k">when</span> <span class="n">A</span> <span class="o">=&gt;</span>
        <span class="n">saida</span> <span class="o">&lt;=</span> <span class="sc">&#39;0&#39;</span><span class="p">;</span>
        <span class="k">if</span> <span class="n">entrada</span><span class="o">=</span><span class="sc">&#39;1&#39;</span> <span class="k">then</span>
          <span class="n">PE</span> <span class="o">&lt;=</span> <span class="n">B</span><span class="p">;</span>
        <span class="k">else</span>
          <span class="n">PE</span> <span class="o">&lt;=</span> <span class="n">A</span><span class="p">;</span>
        <span class="k">end</span> <span class="k">if</span><span class="p">;</span>
      <span class="k">when</span> <span class="n">B</span> <span class="o">=&gt;</span>
        <span class="n">saida</span> <span class="o">&lt;=</span> <span class="sc">&#39;1&#39;</span><span class="p">;</span>
        <span class="k">if</span> <span class="n">entrada</span><span class="o">=</span><span class="sc">&#39;1&#39;</span> <span class="k">then</span>
          <span class="n">PE</span> <span class="o">&lt;=</span> <span class="n">A</span><span class="p">;</span>
        <span class="k">else</span>
          <span class="n">PE</span> <span class="o">&lt;=</span> <span class="n">B</span><span class="p">;</span>
        <span class="k">end</span> <span class="k">if</span><span class="p">;</span>
      <span class="k">when</span> <span class="k">others</span> <span class="o">=&gt;</span>
        <span class="n">saida</span> <span class="o">&lt;=</span> <span class="sc">&#39;0&#39;</span><span class="p">;</span>
        <span class="n">PE</span> <span class="o">&lt;=</span> <span class="n">A</span><span class="p">;</span>
    <span class="k">end</span> <span class="k">case</span><span class="p">;</span>
  <span class="k">end</span> <span class="k">process</span> <span class="nc">combinatorio</span><span class="p">;</span>

<span class="k">end</span> <span class="k">architecture</span> <span class="nc">doisproc</span><span class="p">;</span>
</pre></div>


<p>A vantagem desta abordagem é que temos acesso a estruturas sequenciais, como o <code>case</code> usado como decisor no processo combinatório, que facilitam a descrição comportamental de máquinas de estado. A desvantagem é que um pequeno deslize pode levar o sintetizador a registrar ou inferir <em>latches</em> para os sinais combinatórios, comprometendo a sequencialidade da máquina.</p>
<p>Note que o sinal PE foi incluído na lista de sensibilidade do processo sequencial, o que foi omitido no estilo anterior. A presença na lista de sensibilidade indica que PE pode mudar devido a fatores externos ao processo sequencial, e que o processo deve ser reavaliado se isto acontecer (mesmo que o resultado seja o mesmo pois não há borda nem <em>reset</em>). Já o processo combinatório depende de EA (obrigatório), fechando a cadeia de dependência entre os sinais dos processos (um ativa o outro). Esta ligação amplia as possibilidades de otimização do sintetizador pois ele entende que os dois processos são partes de um circuito único e os algoritmos de síntese foram preparados para otimizar esta situação (é um pouco mais complexo que isso, mas basta saber que é melhor assim). Note que o circuito gerado contém um multiplexador no lugar das portas lógicas.</p>
<p>Este exemplo é simples e há pouca diferença entre em manter o circuito combinatório isolado do sequencial (primeiro estilo), ou descrevê-los em conjunto usando dois processos interligados (segundo estilo). Em circuitos complexos as otimizações podem ser bem diferentes, quase sempre com vantagem para o estilo de descrição com dois processos.</p>
<p>Outro ponto importante é a ausência de sinais temporais no processo combinatório <strong>e a completude de todas as atribuições</strong>. Se esquecermos de uma atribuição para PE em qualquer um dos casos possíveis (incluindo a cláusula <code>when others</code>), a atribuição estará incompleta e o processo pode se tornar sequencial (e nesse caso assíncrono ainda por cima), fazendo com que a descrição não se comporte como o esperado.</p>
<p>Aconselha-se a utilização deste tipo de descrição quando você estiver habituado a descrever máquinas de estados em VHDL e confortável em encontrar problemas de sincronismo.</p>
<p>Se você tem uma bagagem como programador de software, é natural optar por este estilo pois é muito parecido com os processos em software, mas evite-o até estar confortável pois você não está programando e sim descrevendo um hardware. A maioria dos problemas dos alunos iniciantes em práticas de sistemas digitais advém da descrição incorreta deste estilo de máquinas de estado, principalmente ligadas a inferência de <em>latches</em> devido a atribuição incompleta.</p>
<h3>Outros estilos</h3>
<p>Mas então por que não usamos um processo só para tudo? Vamos ver:
<img src='https://balbertini.github.io/images/sd/fsmvhdl03.png' width="50%" align="right" style="padding-left:0%" /></p>
<div class="highlight"><pre><span></span><span class="k">architecture</span> <span class="nc">umproc</span> <span class="k">of</span> <span class="nc">fsm</span> <span class="k">is</span>
  <span class="k">type</span> <span class="n">estado_t</span> <span class="k">is</span> <span class="p">(</span><span class="n">A</span><span class="p">,</span><span class="n">B</span><span class="p">);</span>
  <span class="k">signal</span> <span class="n">EA</span> <span class="o">:</span> <span class="n">estado_t</span><span class="p">;</span>
<span class="k">begin</span>
  <span class="nc">sincrono</span><span class="o">:</span> <span class="k">process</span><span class="p">(</span><span class="n">clock</span><span class="p">,</span> <span class="n">reset_n</span><span class="p">,</span> <span class="n">entrada</span><span class="p">)</span>
  <span class="k">begin</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">reset_n</span><span class="o">=</span><span class="sc">&#39;0&#39;</span><span class="p">)</span> <span class="k">then</span>
      <span class="n">saida</span> <span class="o">&lt;=</span> <span class="sc">&#39;0&#39;</span><span class="p">;</span>
      <span class="n">EA</span> <span class="o">&lt;=</span> <span class="n">A</span><span class="p">;</span>
    <span class="k">elsif</span> <span class="p">(</span><span class="n">rising_edge</span><span class="p">(</span><span class="n">clock</span><span class="p">))</span> <span class="k">then</span>
      <span class="k">case</span><span class="p">(</span><span class="n">EA</span><span class="p">)</span> <span class="k">is</span>
        <span class="k">when</span> <span class="n">A</span> <span class="o">=&gt;</span>
          <span class="n">saida</span> <span class="o">&lt;=</span> <span class="sc">&#39;0&#39;</span><span class="p">;</span>
          <span class="k">if</span> <span class="n">entrada</span><span class="o">=</span><span class="sc">&#39;1&#39;</span> <span class="k">then</span>
            <span class="n">EA</span> <span class="o">&lt;=</span> <span class="n">B</span><span class="p">;</span>
          <span class="k">else</span>
            <span class="n">EA</span> <span class="o">&lt;=</span> <span class="n">A</span><span class="p">;</span>
          <span class="k">end</span> <span class="k">if</span><span class="p">;</span>
        <span class="k">when</span> <span class="n">B</span> <span class="o">=&gt;</span>
          <span class="n">saida</span> <span class="o">&lt;=</span> <span class="sc">&#39;1&#39;</span><span class="p">;</span>
          <span class="k">if</span> <span class="n">entrada</span><span class="o">=</span><span class="sc">&#39;1&#39;</span> <span class="k">then</span>
            <span class="n">EA</span> <span class="o">&lt;=</span> <span class="n">A</span><span class="p">;</span>
          <span class="k">else</span>
            <span class="n">EA</span> <span class="o">&lt;=</span> <span class="n">B</span><span class="p">;</span>
          <span class="k">end</span> <span class="k">if</span><span class="p">;</span>
        <span class="k">when</span> <span class="k">others</span> <span class="o">=&gt;</span>
          <span class="n">saida</span> <span class="o">&lt;=</span> <span class="sc">&#39;0&#39;</span><span class="p">;</span>
          <span class="n">EA</span> <span class="o">&lt;=</span> <span class="n">A</span><span class="p">;</span>
      <span class="k">end</span> <span class="k">case</span><span class="p">;</span>
    <span class="k">end</span> <span class="k">if</span><span class="p">;</span>
  <span class="k">end</span> <span class="k">process</span> <span class="nc">sincrono</span><span class="p">;</span>
<span class="k">end</span> <span class="k">architecture</span> <span class="nc">umproc</span><span class="p">;</span>
</pre></div>


<p>De fato isso é possível, mas o processo será considerado sequencial pelo sintetizador pois contém uma sensibilidade à uma borda (no <code>rising_edge</code>). Como processo sequencial, seus sinais serão registrados, o que é desejável para o sinal EA pois ele representa a própria variável de estado da máquina. Porém, pode não ser desejável tampouco aceitável para os demais sinais. Neste caso, a saída foi o único sinal que sobrou pois o PE pôde ser eliminado, dado que não precisamos mais calcular a função de próximo estado separadamente.</p>
<p>Observe que o circuito gerado possui a saída registrada (inferida pelo sintetizador). Isto não é um problema se você puder conviver com a saída sempre defasada de um ciclo de <em>clock</em>, mas está errado conceitualmente pois a máquina de estados se comportará em fase com o <em>clock</em> para as transições e defasada de um ciclo para os demais sinais. Esta característica costuma confundir muito os iniciantes e dificulta consideravelmente a depuração. Por estes motivos, se você é meu aluno, <strong>não use este estilo</strong> em nenhum momento durante a graduação (pós por favor consulte antes).</p>
<h3>Exemplo 2 (Mealy)</h3>
<p><img src='https://balbertini.github.io/images/sd/fsmexemplo2.png' width="15%" align="right" style="padding-left:5%" />
Esta é a mesma máquina que a do Exemplo 1, porém no modelo de Mealy, onde a saída depende também da entrada.</p>
<div class="highlight"><pre><span></span><span class="k">library</span> <span class="nn">ieee</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">ieee.numeric_bit.rising_edge</span><span class="p">;</span>

<span class="k">entity</span> <span class="nc">fsm</span> <span class="k">is</span>
  <span class="k">port</span><span class="p">(</span>
    <span class="n">entrada</span><span class="o">:</span> <span class="k">in</span> <span class="kt">bit</span><span class="p">;</span>
    <span class="n">saida</span><span class="o">:</span> <span class="k">out</span> <span class="kt">bit</span><span class="p">;</span>
    <span class="n">clock</span><span class="p">,</span> <span class="n">reset_n</span><span class="o">:</span> <span class="k">in</span> <span class="kt">bit</span>
  <span class="p">);</span>
<span class="k">end</span> <span class="nc">fsm</span><span class="p">;</span>
</pre></div>


<div style="border: 0px; overflow: auto;width: 100%;"></div>

<h4>Exemplo 2 (Mealy) - Estilo tradicional</h4>
<p><img src='https://balbertini.github.io/images/sd/fsmvhdl04.png' width="50%" align="right" style="padding-left:0%" /></p>
<div class="highlight"><pre><span></span><span class="k">architecture</span> <span class="nc">proccombmealy</span> <span class="k">of</span> <span class="nc">fsm</span> <span class="k">is</span>
  <span class="k">type</span> <span class="n">estado_t</span> <span class="k">is</span> <span class="p">(</span><span class="n">A</span><span class="p">,</span><span class="n">B</span><span class="p">);</span>
  <span class="k">signal</span> <span class="n">PE</span><span class="p">,</span><span class="n">EA</span> <span class="o">:</span> <span class="n">estado_t</span><span class="p">;</span>
<span class="k">begin</span>

  <span class="nc">sincrono</span><span class="o">:</span> <span class="k">process</span><span class="p">(</span><span class="n">clock</span><span class="p">,</span> <span class="n">reset_n</span><span class="p">)</span>
  <span class="k">begin</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">reset_n</span><span class="o">=</span><span class="sc">&#39;0&#39;</span><span class="p">)</span> <span class="k">then</span>
      <span class="n">EA</span> <span class="o">&lt;=</span> <span class="n">A</span><span class="p">;</span>
    <span class="k">elsif</span> <span class="p">(</span><span class="n">rising_edge</span><span class="p">(</span><span class="n">clock</span><span class="p">))</span> <span class="k">then</span>
      <span class="n">EA</span> <span class="o">&lt;=</span> <span class="n">PE</span><span class="p">;</span>
    <span class="k">end</span> <span class="k">if</span><span class="p">;</span>
  <span class="k">end</span> <span class="k">process</span> <span class="nc">sincrono</span><span class="p">;</span>

  <span class="n">PE</span> <span class="o">&lt;=</span>
    <span class="n">A</span> <span class="k">when</span> <span class="n">entrada</span><span class="o">=</span><span class="sc">&#39;0&#39;</span> <span class="k">and</span> <span class="n">EA</span><span class="o">=</span><span class="n">A</span> <span class="k">else</span>
    <span class="n">B</span> <span class="k">when</span> <span class="n">entrada</span><span class="o">=</span><span class="sc">&#39;1&#39;</span> <span class="k">and</span> <span class="n">EA</span><span class="o">=</span><span class="n">A</span> <span class="k">else</span>
    <span class="n">B</span> <span class="k">when</span> <span class="n">entrada</span><span class="o">=</span><span class="sc">&#39;0&#39;</span> <span class="k">and</span> <span class="n">EA</span><span class="o">=</span><span class="n">B</span> <span class="k">else</span>
    <span class="n">A</span> <span class="k">when</span> <span class="n">entrada</span><span class="o">=</span><span class="sc">&#39;1&#39;</span> <span class="k">and</span> <span class="n">EA</span><span class="o">=</span><span class="n">B</span> <span class="k">else</span>
    <span class="n">A</span><span class="p">;</span>
  <span class="n">saida</span> <span class="o">&lt;=</span>
    <span class="sc">&#39;0&#39;</span> <span class="k">when</span> <span class="n">entrada</span><span class="o">=</span><span class="sc">&#39;0&#39;</span> <span class="k">and</span> <span class="n">EA</span><span class="o">=</span><span class="n">A</span> <span class="k">else</span>
    <span class="sc">&#39;0&#39;</span> <span class="k">when</span> <span class="n">entrada</span><span class="o">=</span><span class="sc">&#39;1&#39;</span> <span class="k">and</span> <span class="n">EA</span><span class="o">=</span><span class="n">A</span> <span class="k">else</span>
    <span class="sc">&#39;1&#39;</span> <span class="k">when</span> <span class="n">entrada</span><span class="o">=</span><span class="sc">&#39;0&#39;</span> <span class="k">and</span> <span class="n">EA</span><span class="o">=</span><span class="n">B</span> <span class="k">else</span>
    <span class="sc">&#39;1&#39;</span> <span class="k">when</span> <span class="n">entrada</span><span class="o">=</span><span class="sc">&#39;1&#39;</span> <span class="k">and</span> <span class="n">EA</span><span class="o">=</span><span class="n">B</span> <span class="k">else</span>
    <span class="sc">&#39;0&#39;</span><span class="p">;</span>
<span class="k">end</span> <span class="k">architecture</span> <span class="nc">proccombmealy</span><span class="p">;</span>
</pre></div>


<p>Note que o circuito gerado é um pouco maior devido a arquitetura para o qual foi sintetizado (FPGA).<div style="border: 0px; overflow: auto;width: 100%;"></div></p>
<h4>Exemplo 2 (Mealy) - Estilo com dois <code>process</code></h4>
<p><img src='https://balbertini.github.io/images/sd/fsmvhdl05.png' width="50%" align="right" style="padding-left:0%" /></p>
<div class="highlight"><pre><span></span><span class="k">architecture</span> <span class="nc">doisprocmealy</span> <span class="k">of</span> <span class="nc">fsm</span> <span class="k">is</span>
  <span class="k">type</span> <span class="n">estado_t</span> <span class="k">is</span> <span class="p">(</span><span class="n">A</span><span class="p">,</span><span class="n">B</span><span class="p">);</span>
  <span class="k">signal</span> <span class="n">PE</span><span class="p">,</span><span class="n">EA</span> <span class="o">:</span> <span class="n">estado_t</span><span class="p">;</span>
<span class="k">begin</span>

  <span class="nc">sincrono</span><span class="o">:</span> <span class="k">process</span><span class="p">(</span><span class="n">clock</span><span class="p">,</span> <span class="n">reset_n</span><span class="p">,</span> <span class="n">PE</span><span class="p">)</span>
  <span class="k">begin</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">reset_n</span><span class="o">=</span><span class="sc">&#39;0&#39;</span><span class="p">)</span> <span class="k">then</span>
      <span class="n">EA</span> <span class="o">&lt;=</span> <span class="n">A</span><span class="p">;</span>
    <span class="k">elsif</span> <span class="p">(</span><span class="n">rising_edge</span><span class="p">(</span><span class="n">clock</span><span class="p">))</span> <span class="k">then</span>
      <span class="n">EA</span> <span class="o">&lt;=</span> <span class="n">PE</span><span class="p">;</span>
    <span class="k">end</span> <span class="k">if</span><span class="p">;</span>
  <span class="k">end</span> <span class="k">process</span> <span class="nc">sincrono</span><span class="p">;</span>

  <span class="nc">combinatorio</span><span class="o">:</span> <span class="k">process</span><span class="p">(</span><span class="n">EA</span><span class="p">,</span> <span class="n">entrada</span><span class="p">)</span>
  <span class="k">begin</span>
    <span class="n">saida</span> <span class="o">&lt;=</span> <span class="sc">&#39;0&#39;</span><span class="p">;</span>
    <span class="k">case</span><span class="p">(</span><span class="n">EA</span><span class="p">)</span> <span class="k">is</span>
      <span class="k">when</span> <span class="n">A</span> <span class="o">=&gt;</span>
        <span class="k">if</span> <span class="n">entrada</span><span class="o">=</span><span class="sc">&#39;1&#39;</span> <span class="k">then</span>
          <span class="n">saida</span> <span class="o">&lt;=</span> <span class="sc">&#39;0&#39;</span><span class="p">;</span>
          <span class="n">PE</span> <span class="o">&lt;=</span> <span class="n">B</span><span class="p">;</span>
        <span class="k">else</span>
          <span class="n">saida</span> <span class="o">&lt;=</span> <span class="sc">&#39;0&#39;</span><span class="p">;</span>
          <span class="n">PE</span> <span class="o">&lt;=</span> <span class="n">A</span><span class="p">;</span>
        <span class="k">end</span> <span class="k">if</span><span class="p">;</span>
      <span class="k">when</span> <span class="n">B</span> <span class="o">=&gt;</span>
        <span class="k">if</span> <span class="n">entrada</span><span class="o">=</span><span class="sc">&#39;1&#39;</span> <span class="k">then</span>
          <span class="n">saida</span> <span class="o">&lt;=</span> <span class="sc">&#39;1&#39;</span><span class="p">;</span>
          <span class="n">PE</span> <span class="o">&lt;=</span> <span class="n">A</span><span class="p">;</span>
        <span class="k">else</span>
          <span class="n">saida</span> <span class="o">&lt;=</span> <span class="sc">&#39;1&#39;</span><span class="p">;</span>
          <span class="n">PE</span> <span class="o">&lt;=</span> <span class="n">B</span><span class="p">;</span>
        <span class="k">end</span> <span class="k">if</span><span class="p">;</span>
      <span class="k">when</span> <span class="k">others</span> <span class="o">=&gt;</span>
        <span class="n">saida</span> <span class="o">&lt;=</span> <span class="sc">&#39;0&#39;</span><span class="p">;</span>
        <span class="n">PE</span> <span class="o">&lt;=</span> <span class="n">A</span><span class="p">;</span>
    <span class="k">end</span> <span class="k">case</span><span class="p">;</span>
  <span class="k">end</span> <span class="k">process</span> <span class="nc">combinatorio</span><span class="p">;</span>

<span class="k">end</span> <span class="k">architecture</span> <span class="nc">doisprocmealy</span><span class="p">;</span>
</pre></div>


<p>Observe que não há diferença entre o circuito gerado para esta máquina e para a máquina Moore com dois processos.
<div style="border: 0px; overflow: auto;width: 100%;"></div></p>
<!-- ### Dicas gerais

Use nomes significativos. Para estados, tente -->
  </div>
  <div class="tag-cloud">
    <p>
      <a href="https://balbertini.github.io/tag/vhdl.html">vhdl</a>
      <a href="https://balbertini.github.io/tag/state-machine.html">state machine</a>
    </p>
  </div>





<!-- Disqus -->
<div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'balbertini';
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>
    Habilite JavaScript para ver os comentários.
</noscript>
<!-- End Disqus -->
</article>

    <footer>
<p>
  &copy; Bruno Albertini 2014 - This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a>
</p>
<p>
Criado com o <a href="http://getpelican.com" target="_blank">Pelican</a> usando o tema <a href="http://bit.ly/flex-pelican" target="_blank">Flex</a>
</p><p>
  <a rel="license"
     href="http://creativecommons.org/licenses/by-sa/4.0/"
     target="_blank">
    <img alt="Creative Commons License"
         title="Creative Commons License"
         style="border-width:0"
           src="https://i.creativecommons.org/l/by-sa/4.0/80x15.png"
         width="80"
         height="15"/>
  </a>
</p>    </footer>
  </main>




<script type="application/ld+json">
{
  "@context" : "http://schema.org",
  "@type" : "Blog",
  "name": " B.Albertini's site ",
  "url" : "https://balbertini.github.io",
  "image": "/images/profile.png",
  "description": ""
}
</script>


</body>
</html>